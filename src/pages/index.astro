---
import BaseLayout from '../layouts/BaseLayout.astro';
import latestRelease from '../../public/latest.json';
import { AUTH_ENABLED } from '../lib/auth';
import { readdirSync, readFileSync } from 'node:fs';
import { extname, basename } from 'node:path';

const title = 'EasyBackupManager — Set-and-forget backups with reliable restore';
const description = 'EasyBackupManager (EBM) is a free desktop backup app for Windows and Linux. A fast, performant C++ GUI wrapper for restic — privacy-friendly, secure, and easy to use for reliable backups and restores.';

const version = latestRelease?.version ?? '';
const tag = latestRelease?.tag ?? '';
const repoBase = latestRelease?.repo_base_url ?? 'https://github.com/EasyBackupManager/EasyBackupManager.github.io/';
const winFile = latestRelease?.files?.windows;
const linuxFile = latestRelease?.files?.linux;

const makeReleaseUrl = (repo, tag) => {
  if (!repo) return '';
  if (!tag) return repo;
  try {
    if (repo.includes('/releases/tag')) {
      return repo.endsWith('/') ? `${repo}${tag}` : `${repo}/${tag}`;
    }
    if (repo.endsWith('/')) return `${repo}releases/tag/${tag}`;
    return `${repo}/releases/tag/${tag}`;
  } catch (e) {
    return repo;
  }
};

const makeDownloadUrl = (repo, tag, filename) => {
  if (!repo || !tag || !filename) return '';
  try {
    if (repo.includes('/releases/download')) {
      return repo.endsWith('/') ? `${repo}${tag}/${filename}` : `${repo}/${tag}/${filename}`;
    }
    if (repo.includes('/releases/tag')) {
      const base = repo.replace('/releases/tag', '/releases/download').replace(/\/$/, '');
      return `${base}/${tag}/${filename}`;
    }
    return repo.endsWith('/') ? `${repo}releases/download/${tag}/${filename}` : `${repo}/releases/download/${tag}/${filename}`;
  } catch (e) {
    return '';
  }
};

const winUrl = makeDownloadUrl(repoBase, tag, winFile?.name);
const linuxUrl = makeDownloadUrl(repoBase, tag, linuxFile?.name);
const releaseUrl = makeReleaseUrl(repoBase, tag);

const transparentPixel = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

const readPngDimensions = (fileUrl) => {
  try {
    const bytes = readFileSync(fileUrl);
    if (bytes.length < 24) return null;

    const isPng =
      bytes[0] === 0x89 &&
      bytes[1] === 0x50 &&
      bytes[2] === 0x4e &&
      bytes[3] === 0x47;

    if (!isPng) return null;

    const width = bytes.readUInt32BE(16);
    const height = bytes.readUInt32BE(20);
    if (!width || !height) return null;
    return { width, height };
  } catch {
    return null;
  }
};

const screenshotDir = new URL('../../public/screenshots/', import.meta.url);
let screenshots = [];
try {
  const byOrder = new Map();
  for (const entry of readdirSync(screenshotDir, { withFileTypes: true })) {
    if (!entry.isFile()) continue;

    const extension = extname(entry.name).toLowerCase();
    const stem = basename(entry.name, extension);
    if (extension.length <= 1 || !/^\d+$/.test(stem)) continue;

    const order = Number.parseInt(stem, 10);
    if (!Number.isFinite(order)) continue;

    const existing = byOrder.get(order) ?? { order, variants: new Map() };
    existing.variants.set(extension, entry.name);
    byOrder.set(order, existing);
  }

  const preferredFormats = ['.webp', '.avif', '.png', '.jpg', '.jpeg', '.gif'];
  screenshots = [...byOrder.values()]
    .sort((a, b) => a.order - b.order)
    .map((item) => {
      const selectedExt =
        preferredFormats.find((ext) => item.variants.has(ext)) ?? [...item.variants.keys()][0];
      const selectedName = item.variants.get(selectedExt);
      const dimensionName = item.variants.get('.png') ?? selectedName;
      const dimensions =
        dimensionName && dimensionName.endsWith('.png')
          ? readPngDimensions(new URL(dimensionName, screenshotDir))
          : null;

      return {
        order: item.order,
        src: `/screenshots/${selectedName}`,
        width: dimensions?.width ?? undefined,
        height: dimensions?.height ?? undefined,
      };
    });
} catch {
  screenshots = [];
}
---

<BaseLayout title={title} description={description} version={version}>
  <!-- ===== UNDER CONSTRUCTION (not logged in) ===== -->
  {AUTH_ENABLED ? (
    <div id="under-construction" style="display:none;min-height:80vh;flex-direction:column;align-items:center;justify-content:center;padding:2rem;">
      <img src="/images/under_construction.png" alt="Under Construction" style="max-width:420px;width:100%;height:auto;" />
      <a href="/login/" class="btn btn-primary" style="margin-top:2rem;font-size:1.1rem;padding:0.75rem 2.5rem;">Login</a>
    </div>
  ) : null}

  <!-- ===== MAIN CONTENT (logged in or auth disabled) ===== -->
  <div id="main-content" style={`display:${AUTH_ENABLED ? 'none' : 'block'};`}>
  <!-- ===== 1. HERO ===== -->
  <section class="hero container">
    <img src="/images/logo.svg" alt="EasyBackupManager logo" class="hero-logo" width="96" height="96" />
    <h1>Set-and-forget backups,<br />with reliable restore</h1>
    <p>EasyBackupManager (EBM) wraps the power of <strong>restic</strong> in a clean desktop GUI for <strong>Windows</strong> and <strong>Linux</strong>. EasyBackupManager is Free Software.</p>
    <p class="hero-badges" style="margin-top:var(--space-md);">
      <span class="badge">Free</span>
      <span class="badge">restic-powered</span>
      <span class="badge">Windows &amp; Linux</span>
      <span class="badge">Privacy-friendly</span>
      <span class="badge">Built in C++</span>
      <span class="badge">Fast &amp; performant</span>
    </p>
    <div class="btn-group">
      <a href="/download/" class="btn btn-primary">Download EBM</a>
      <a href="https://github.com/EasyBackupManager/EasyBackupManager.github.io/releases" target="_blank" rel="noopener" class="btn btn-secondary">View on GitHub</a>
    </div>
  </section>

  <!-- ===== 2. INTERFACE PREVIEW ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">Interface preview</h2>
      <p class="section-subtitle">Clean, focused, and built for clarity. Here's what EBM looks like in action.</p>
      {screenshots.length > 0 ? (
        <Fragment>
          <div class="screenshot-carousel" id="screenshot-carousel" aria-label="Interface preview carousel">
            <button class="carousel-arrow" type="button" data-action="prev" aria-label="Previous screenshot">&larr;</button>
            <div class="carousel-viewport">
              <div class="carousel-track">
                {screenshots.map((shot, idx) => (
                  <button
                    type="button"
                    class={`carousel-slide ${idx === 0 ? 'is-active' : ''}`}
                    data-index={idx}
                    data-src={shot.src}
                    aria-label={`Open screenshot ${idx + 1} in fullscreen`}
                  >
                    <img
                      src={idx === 0 ? shot.src : transparentPixel}
                      data-src={shot.src}
                      data-loaded={idx === 0 ? '1' : '0'}
                      alt={`EBM interface preview ${idx + 1}`}
                      loading={idx === 0 ? 'eager' : 'lazy'}
                      decoding="async"
                      width={shot.width}
                      height={shot.height}
                      fetchpriority={idx === 0 ? 'high' : undefined}
                    />
                  </button>
                ))}
              </div>
            </div>
            <button class="carousel-arrow" type="button" data-action="next" aria-label="Next screenshot">&rarr;</button>
          </div>

          <div class="carousel-dots" id="screenshot-dots" aria-label="Carousel pagination">
            {screenshots.map((_, idx) => (
              <button
                type="button"
                class={`carousel-dot ${idx === 0 ? 'is-active' : ''}`}
                data-index={idx}
                aria-label={`Go to screenshot ${idx + 1}`}
              />
            ))}
          </div>

          <div class="screenshot-lightbox" id="screenshot-lightbox" hidden role="dialog" aria-modal="true" aria-label="Screenshot viewer">
            <button class="lightbox-close" type="button" data-action="close" aria-label="Close fullscreen view">&times;</button>
            <button class="lightbox-arrow" type="button" data-action="prev" aria-label="Previous screenshot">&larr;</button>
            <figure class="lightbox-figure">
              <img id="lightbox-image" alt="" />
              <figcaption id="lightbox-caption"></figcaption>
            </figure>
            <button class="lightbox-arrow" type="button" data-action="next" aria-label="Next screenshot">&rarr;</button>
          </div>
        </Fragment>
      ) : (
        <p class="section-subtitle">No screenshots found. Add files in `public/screenshots/` named 1, 2, 3, ... (any image extension).</p>
      )}
    </div>
  </section>

  <!-- ===== 2. WHY EBM EXISTS ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">Why EasyBackupManager exists</h2>
      <p class="section-subtitle">restic is an excellent, battle-tested backup engine — but its command-line interface can be intimidating. EBM gives you all of restic's reliability through a straightforward graphical interface, so you can protect your data without memorizing terminal commands.</p>
    </div>
  </section>

  <!-- ===== 3. KEY DIFFERENTIATORS ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">What makes EBM different</h2>
      <div class="card-grid">
        <div class="card">
          <h3>Standout restore experience</h3>
          <p>Browse and restore individual files or full snapshots with confidence. EBM's restore interface is designed to be clear and stress-free — because restores matter most when things go wrong.</p>
        </div>
        <div class="card">
          <h3>Intuitive simplicity</h3>
          <p>No flags to remember, no config files to edit. Create backup profiles, pick your sources and destination, and let EBM handle the rest.</p>
        </div>
        <div class="card">
          <h3>Backup profiles</h3>
          <p>Organise different backup jobs into named profiles — each with its own source directories, repository, and retention policy.</p>
        </div>
        <div class="card">
          <h3>Retention policies</h3>
          <p>Set how many daily, weekly, and monthly snapshots to keep. EBM automatically prunes old snapshots to free up space while keeping your safety net intact.</p>
        </div>
        <div class="card">
          <h3>Repository health checks</h3>
          <p>Run integrity checks and prune operations on your restic repositories directly from the GUI — no terminal needed.</p>
        </div>
        <div class="card">
          <h3>Windows &amp; Linux</h3>
          <p>First-class support for both platforms. The same intuitive experience whether you're on Windows 10/11 or your favourite Linux distribution.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 4. HOW IT WORKS ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">How it works</h2>
      <p class="section-subtitle">EBM currently supports <strong>local repositories only</strong>. Back up to an external drive, NAS mount, or any locally-accessible path.</p>
      <ol class="steps">
        <li>
          <strong>Create a profile</strong>
          Give it a name, pick the folders you want to back up, and choose a local destination.
        </li>
        <li>
          <strong>Set retention rules</strong>
          Decide how many snapshots to keep (daily / weekly / monthly).
        </li>
        <li>
          <strong>Run your backup</strong>
          Click "Backup" and EBM handles the restic commands behind the scenes.
        </li>
        <li>
          <strong>Restore when you need to</strong>
          Browse snapshots, select files or folders, and restore with a few clicks.
        </li>
      </ol>
    </div>
  </section>

  <!-- ===== 5. SECURITY & ARCHITECTURE ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">Security &amp; Architecture</h2>
      <div class="card-grid">
        <div class="card">
          <h3>restic encryption</h3>
          <p>All backup data is encrypted at rest by restic using AES-256. EBM never weakens or bypasses this encryption.</p>
        </div>
        <div class="card">
          <h3>Credential storage</h3>
          <p>Repository passwords are stored in an <strong>encrypted local config</strong> file, which is a temporary solution. <span class="badge badge-planned">Planned</span> OS keyring integration will provide stronger protection in a future release.</p>
        </div>
        <div class="card">
          <h3>Local repositories only</h3>
          <p>Currently, backups are stored on locally-accessible paths (external drives, NAS mounts). <span class="badge badge-planned">Planned</span> Cloud backends (S3, B2, rclone, rest-server) are on the roadmap.</p>
        </div>
        <div class="card">
          <h3>Telemetry (opt-out)</h3>
          <p>EBM includes minimal, <strong>opt-out</strong> telemetry: anonymous usage counters and crash reports. It is <strong>off by default</strong> and can be disabled in Settings. No file contents, backup data, or credentials are ever collected. <a href="/privacy/">Read the full policy&nbsp;&rarr;</a></p>
        </div>
      </div>

      <h3 style="margin-top:var(--space-xl);margin-bottom:var(--space-md);font-size:1.1rem;">On the roadmap <span class="badge badge-planned">Planned</span></h3>
      <ul style="padding-left:1.5rem;color:var(--color-muted);">
        <li>Scheduled / automatic backups</li>
        <li>Cloud backends (S3, B2, rclone, rest-server)</li>
        <li>Command preview (see the restic command before it runs)</li>
        <li>OS keyring credential storage</li>
      </ul>
    </div>
  </section>

  <!-- ===== 6. RESTORE CONFIDENCE ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">Restore with confidence</h2>
      <p class="section-subtitle">A backup is only as good as its restore. We strongly recommend running a <strong>test restore</strong> after your first backup to make sure everything works as expected.</p>
      <div class="card" style="max-width:540px;">
        <h3>Test restore checklist</h3>
        <ol style="padding-left:1.5rem;margin-top:var(--space-sm);color:var(--color-muted);">
          <li>Run a full backup with EBM.</li>
          <li>Open the Restore view and select the latest snapshot.</li>
          <li>Restore a few files to a temporary folder.</li>
          <li>Verify the restored files match your originals.</li>
        </ol>
        <p style="margin-top:var(--space-md);font-size:0.9rem;color:var(--color-muted);">This takes just a few minutes and gives you peace of mind that your data is safe.</p>
      </div>
    </div>
  </section>

  <!-- Download section moved to /download -->
  </div><!-- end #main-content -->

  <script is:inline>
    (function () {
      var carousel = document.getElementById('screenshot-carousel');
      if (!carousel) return;

      var track = carousel.querySelector('.carousel-track');
      var slides = Array.from(carousel.querySelectorAll('.carousel-slide'));
      var dotsRoot = document.getElementById('screenshot-dots');
      var dots = dotsRoot ? Array.from(dotsRoot.querySelectorAll('.carousel-dot')) : [];
      var prevBtn = carousel.querySelector('[data-action="prev"]');
      var nextBtn = carousel.querySelector('[data-action="next"]');

      var lightbox = document.getElementById('screenshot-lightbox');
      var lightboxImage = document.getElementById('lightbox-image');
      var lightboxCaption = document.getElementById('lightbox-caption');
      var closeBtn = lightbox ? lightbox.querySelector('[data-action="close"]') : null;
      var lightboxPrev = lightbox ? lightbox.querySelector('[data-action="prev"]') : null;
      var lightboxNext = lightbox ? lightbox.querySelector('[data-action="next"]') : null;

      if (!track || slides.length === 0) return;

      var activeIndex = 0;
      var isLightboxOpen = false;

      function wrapIndex(index) {
        if (slides.length === 0) return 0;
        return (index + slides.length) % slides.length;
      }

      function ensureSlideImageLoaded(index) {
        var resolvedIndex = wrapIndex(index);
        var slide = slides[resolvedIndex];
        if (!slide) return;
        var image = slide.querySelector('img[data-src]');
        if (!image || image.getAttribute('data-loaded') === '1') return;
        var src = image.getAttribute('data-src');
        if (!src) return;
        image.src = src;
        image.setAttribute('data-loaded', '1');
      }

      function render() {
        track.style.transform = 'translateX(-' + activeIndex * 100 + '%)';
        slides.forEach(function (slide, idx) {
          slide.classList.toggle('is-active', idx === activeIndex);
        });
        dots.forEach(function (dot, idx) {
          dot.classList.toggle('is-active', idx === activeIndex);
        });
        ensureSlideImageLoaded(activeIndex);
        ensureSlideImageLoaded(activeIndex + 1);
      }

      function setActive(index) {
        activeIndex = wrapIndex(index);
        render();
      }

      function openLightbox(index) {
        if (!lightbox || !lightboxImage) return;
        setActive(index);
        ensureSlideImageLoaded(activeIndex);
        var src = slides[activeIndex].getAttribute('data-src') || '';
        lightboxImage.src = src;
        lightboxImage.alt = 'EBM interface preview ' + (activeIndex + 1);
        if (lightboxCaption) {
          lightboxCaption.textContent = 'Screenshot ' + (activeIndex + 1) + ' of ' + slides.length;
        }
        lightbox.hidden = false;
        document.body.style.overflow = 'hidden';
        isLightboxOpen = true;
      }

      function closeLightbox() {
        if (!lightbox || !lightboxImage) return;
        lightbox.hidden = true;
        lightboxImage.removeAttribute('src');
        document.body.style.overflow = '';
        isLightboxOpen = false;
      }

      function step(delta) {
        setActive(activeIndex + delta);
        if (!isLightboxOpen || !lightboxImage) return;
        var src = slides[activeIndex].getAttribute('data-src') || '';
        lightboxImage.src = src;
        lightboxImage.alt = 'EBM interface preview ' + (activeIndex + 1);
        if (lightboxCaption) {
          lightboxCaption.textContent = 'Screenshot ' + (activeIndex + 1) + ' of ' + slides.length;
        }
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', function () {
          step(-1);
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          step(1);
        });
      }

      slides.forEach(function (slide, idx) {
        slide.addEventListener('click', function () {
          if (idx === activeIndex) {
            openLightbox(idx);
          } else {
            setActive(idx);
          }
        });
      });

      dots.forEach(function (dot, idx) {
        dot.addEventListener('click', function () {
          setActive(idx);
        });
      });

      if (closeBtn) {
        closeBtn.addEventListener('click', function () {
          closeLightbox();
        });
      }

      if (lightboxPrev) {
        lightboxPrev.addEventListener('click', function () {
          step(-1);
        });
      }

      if (lightboxNext) {
        lightboxNext.addEventListener('click', function () {
          step(1);
        });
      }

      if (lightbox) {
        lightbox.addEventListener('click', function (e) {
          if (e.target === lightbox) closeLightbox();
        });
      }

      document.addEventListener('keydown', function (e) {
        if (!isLightboxOpen) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') step(-1);
        if (e.key === 'ArrowRight') step(1);
      });

      render();
    })();
  </script>

  {AUTH_ENABLED ? (
    <script is:inline>
      (function () {
        var authed = sessionStorage.getItem('ebm_auth') === '1';
        var uc = document.getElementById('under-construction');
        var mc = document.getElementById('main-content');
        if (authed) {
          uc.style.display = 'none';
          mc.style.display = 'block';
        } else {
          uc.style.display = 'flex';
          mc.style.display = 'none';
        }
      })();
    </script>
  ) : null}
</BaseLayout>

---
import BaseLayout from '../layouts/BaseLayout.astro';
import latestRelease from '../../public/latest.json';
import { AUTH_ENABLED } from '../lib/auth';

const title = 'EasyBackupManager — Set-and-forget backups with reliable restore';
const description = 'EasyBackupManager (EBM) is a free desktop backup app for Windows and Linux. A fast, performant C++ GUI wrapper for restic — privacy-friendly, secure, and easy to use for reliable backups and restores.';

const version = latestRelease?.version ?? '';
const tag = latestRelease?.tag ?? '';
const repoBase = latestRelease?.repo_base_url ?? 'https://github.com/EasyBackupManager/EasyBackupManager.github.io/';
const winFile = latestRelease?.files?.windows;
const linuxFile = latestRelease?.files?.linux;

const makeReleaseUrl = (repo, tag) => {
  if (!repo) return '';
  if (!tag) return repo;
  try {
    if (repo.includes('/releases/tag')) {
      return repo.endsWith('/') ? `${repo}${tag}` : `${repo}/${tag}`;
    }
    if (repo.endsWith('/')) return `${repo}releases/tag/${tag}`;
    return `${repo}/releases/tag/${tag}`;
  } catch (e) {
    return repo;
  }
};

const makeDownloadUrl = (repo, tag, filename) => {
  if (!repo || !tag || !filename) return '';
  try {
    if (repo.includes('/releases/download')) {
      return repo.endsWith('/') ? `${repo}${tag}/${filename}` : `${repo}/${tag}/${filename}`;
    }
    if (repo.includes('/releases/tag')) {
      const base = repo.replace('/releases/tag', '/releases/download').replace(/\/$/, '');
      return `${base}/${tag}/${filename}`;
    }
    return repo.endsWith('/') ? `${repo}releases/download/${tag}/${filename}` : `${repo}/releases/download/${tag}/${filename}`;
  } catch (e) {
    return '';
  }
};

const winUrl = makeDownloadUrl(repoBase, tag, winFile?.name);
const linuxUrl = makeDownloadUrl(repoBase, tag, linuxFile?.name);
const releaseUrl = makeReleaseUrl(repoBase, tag);
---

<BaseLayout title={title} description={description} version={version}>
  <!-- ===== UNDER CONSTRUCTION (not logged in) ===== -->
  {AUTH_ENABLED ? (
    <div id="under-construction" style="display:none;min-height:80vh;flex-direction:column;align-items:center;justify-content:center;padding:2rem;">
      <img src="/images/under_construction.png" alt="Under Construction" style="max-width:420px;width:100%;height:auto;" />
      <a href="/login" class="btn btn-primary" style="margin-top:2rem;font-size:1.1rem;padding:0.75rem 2.5rem;">Login</a>
    </div>
  ) : null}

  <!-- ===== MAIN CONTENT (logged in or auth disabled) ===== -->
  <div id="main-content" style={`display:${AUTH_ENABLED ? 'none' : 'block'};`}>
  <!-- ===== 1. HERO ===== -->
  <section class="hero container">
    <img src="/logo.svg" alt="EasyBackupManager logo" class="hero-logo" width="96" height="96" />
    <h1>Set-and-forget backups,<br />with reliable restore</h1>
    <p>EasyBackupManager (EBM) wraps the power of <strong>restic</strong> in a clean desktop GUI for <strong>Windows</strong> and <strong>Linux</strong>. Free.</p>
    <p class="hero-badges" style="margin-top:var(--space-md);">
      <span class="badge">Free</span>
      <span class="badge">restic-powered</span>
      <span class="badge">Windows &amp; Linux</span>
      <span class="badge">Privacy-friendly</span>
      <span class="badge">Built in C++</span>
      <span class="badge">Fast &amp; performant</span>
    </p>
    <div class="btn-group">
      <a href="/download" class="btn btn-primary">Download EBM</a>
      <a href="https://github.com/EasyBackupManager/EasyBackupManager.github.io/releases" target="_blank" rel="noopener" class="btn btn-secondary">View on GitHub</a>
    </div>
  </section>

  <!-- ===== 2. WHY EBM EXISTS ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">Why EasyBackupManager exists</h2>
      <p class="section-subtitle">restic is an excellent, battle-tested backup engine — but its command-line interface can be intimidating. EBM gives you all of restic's reliability through a straightforward graphical interface, so you can protect your data without memorizing terminal commands.</p>
    </div>
  </section>

  <!-- ===== 3. KEY DIFFERENTIATORS ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">What makes EBM different</h2>
      <div class="card-grid">
        <div class="card">
          <h3>Standout restore experience</h3>
          <p>Browse and restore individual files or full snapshots with confidence. EBM's restore interface is designed to be clear and stress-free — because restores matter most when things go wrong.</p>
        </div>
        <div class="card">
          <h3>Intuitive simplicity</h3>
          <p>No flags to remember, no config files to edit. Create backup profiles, pick your sources and destination, and let EBM handle the rest.</p>
        </div>
        <div class="card">
          <h3>Backup profiles</h3>
          <p>Organise different backup jobs into named profiles — each with its own source directories, repository, and retention policy.</p>
        </div>
        <div class="card">
          <h3>Retention policies</h3>
          <p>Set how many daily, weekly, and monthly snapshots to keep. EBM automatically prunes old snapshots to free up space while keeping your safety net intact.</p>
        </div>
        <div class="card">
          <h3>Repository health checks</h3>
          <p>Run integrity checks and prune operations on your restic repositories directly from the GUI — no terminal needed.</p>
        </div>
        <div class="card">
          <h3>Windows &amp; Linux</h3>
          <p>First-class support for both platforms. The same intuitive experience whether you're on Windows 10/11 or your favourite Linux distribution.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 4. HOW IT WORKS ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">How it works</h2>
      <p class="section-subtitle">EBM currently supports <strong>local repositories only</strong>. Back up to an external drive, NAS mount, or any locally-accessible path.</p>
      <ol class="steps">
        <li>
          <strong>Create a profile</strong>
          Give it a name, pick the folders you want to back up, and choose a local destination.
        </li>
        <li>
          <strong>Set retention rules</strong>
          Decide how many snapshots to keep (daily / weekly / monthly).
        </li>
        <li>
          <strong>Run your backup</strong>
          Click "Backup" and EBM handles the restic commands behind the scenes.
        </li>
        <li>
          <strong>Restore when you need to</strong>
          Browse snapshots, select files or folders, and restore with a few clicks.
        </li>
      </ol>
    </div>
  </section>

  <!-- ===== 5. SECURITY & ARCHITECTURE ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">Security &amp; Architecture</h2>
      <div class="card-grid">
        <div class="card">
          <h3>restic encryption</h3>
          <p>All backup data is encrypted at rest by restic using AES-256. EBM never weakens or bypasses this encryption.</p>
        </div>
        <div class="card">
          <h3>Credential storage</h3>
          <p>Repository passwords are stored in an <strong>encrypted local config</strong> file, which is a temporary solution. <span class="badge badge-planned">Planned</span> OS keyring integration will provide stronger protection in a future release.</p>
        </div>
        <div class="card">
          <h3>Local repositories only</h3>
          <p>Currently, backups are stored on locally-accessible paths (external drives, NAS mounts). <span class="badge badge-planned">Planned</span> Cloud backends (S3, B2, rclone, rest-server) are on the roadmap.</p>
        </div>
        <div class="card">
          <h3>Telemetry (opt-out)</h3>
          <p>EBM includes minimal, <strong>opt-out</strong> telemetry: anonymous usage counters and crash reports. It is <strong>off by default</strong> and can be disabled in Settings. No file contents, backup data, or credentials are ever collected. <a href="/privacy">Read the full policy&nbsp;&rarr;</a></p>
        </div>
      </div>

      <h3 style="margin-top:var(--space-xl);margin-bottom:var(--space-md);font-size:1.1rem;">On the roadmap <span class="badge badge-planned">Planned</span></h3>
      <ul style="padding-left:1.5rem;color:var(--color-muted);">
        <li>Scheduled / automatic backups</li>
        <li>Cloud backends (S3, B2, rclone, rest-server)</li>
        <li>Command preview (see the restic command before it runs)</li>
        <li>OS keyring credential storage</li>
      </ul>
    </div>
  </section>

  <!-- ===== 6. RESTORE CONFIDENCE ===== -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">Restore with confidence</h2>
      <p class="section-subtitle">A backup is only as good as its restore. We strongly recommend running a <strong>test restore</strong> after your first backup to make sure everything works as expected.</p>
      <div class="card" style="max-width:540px;">
        <h3>Test restore checklist</h3>
        <ol style="padding-left:1.5rem;margin-top:var(--space-sm);color:var(--color-muted);">
          <li>Run a full backup with EBM.</li>
          <li>Open the Restore view and select the latest snapshot.</li>
          <li>Restore a few files to a temporary folder.</li>
          <li>Verify the restored files match your originals.</li>
        </ol>
        <p style="margin-top:var(--space-md);font-size:0.9rem;color:var(--color-muted);">This takes just a few minutes and gives you peace of mind that your data is safe.</p>
      </div>
    </div>
  </section>

  <!-- ===== 7. INTERFACE PREVIEW ===== -->
  <section class="section-alt">
    <div class="container">
      <h2 class="section-title">Interface preview</h2>
      <p class="section-subtitle">Clean, focused, and built for clarity. Here's what EBM looks like in action.</p>
      <div class="screenshot-grid">
        <img src="/screenshots/backup-view.svg" alt="EBM backup view" loading="lazy" />
        <img src="/screenshots/restore-view.svg" alt="EBM restore view" loading="lazy" />
      </div>
    </div>
  </section>

  <!-- Download section moved to /download -->
  </div><!-- end #main-content -->

  {AUTH_ENABLED ? (
    <script is:inline>
      (function () {
        var authed = sessionStorage.getItem('ebm_auth') === '1';
        var uc = document.getElementById('under-construction');
        var mc = document.getElementById('main-content');
        if (authed) {
          uc.style.display = 'none';
          mc.style.display = 'block';
        } else {
          uc.style.display = 'flex';
          mc.style.display = 'none';
        }
      })();
    </script>
  ) : null}
</BaseLayout>



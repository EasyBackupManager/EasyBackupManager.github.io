---
import BaseLayout from '../layouts/BaseLayout.astro';
import latestRelease from '../../public/latest.json';

const title = 'Download EasyBackupManager';
const description = 'Download the latest EasyBackupManager releases and checksums.';

const hasRelease = latestRelease?.version && latestRelease?.files;
const version = latestRelease?.version ?? '';
const tag = latestRelease?.tag ?? '';
const repoBase = latestRelease?.repo_base_url ?? 'https://github.com/EasyBackupManager/EasyBackupManager.github.io/';
const winFile = latestRelease?.files?.windows;
const linuxFile = latestRelease?.files?.linux;

const makeReleaseUrl = (repo, tag) => {
  if (!repo) return '';
  if (!tag) return repo;
  try {
    if (repo.includes('/releases/tag')) {
      return repo.endsWith('/') ? `${repo}${tag}` : `${repo}/${tag}`;
    }
    if (repo.endsWith('/')) return `${repo}releases/tag/${tag}`;
    return `${repo}/releases/tag/${tag}`;
  } catch (e) {
    return repo;
  }
};

const makeDownloadUrl = (repo, tag, filename) => {
  if (!repo || !tag || !filename) return '';
  try {
    if (repo.includes('/releases/download')) {
      return repo.endsWith('/') ? `${repo}${tag}/${filename}` : `${repo}/${tag}/${filename}`;
    }
    if (repo.includes('/releases/tag')) {
      const base = repo.replace('/releases/tag', '/releases/download').replace(/\/$/, '');
      return `${base}/${tag}/${filename}`;
    }
    return repo.endsWith('/') ? `${repo}releases/download/${tag}/${filename}` : `${repo}/releases/download/${tag}/${filename}`;
  } catch (e) {
    return '';
  }
};

const winUrl = makeDownloadUrl(repoBase, tag, winFile?.name);
const linuxUrl = makeDownloadUrl(repoBase, tag, linuxFile?.name);
const releaseUrl = makeReleaseUrl(repoBase, tag);

const parseGitHubRepo = (repoUrl) => {
  if (!repoUrl) return null;
  try {
    const { hostname, pathname } = new URL(repoUrl);
    if (hostname !== 'github.com') return null;
    const [owner, repo] = pathname.split('/').filter(Boolean);
    if (!owner || !repo) return null;
    return `${owner}/${repo.replace(/\.git$/i, '')}`;
  } catch (e) {
    return null;
  }
};

const fetchReleases = async (repoSlug) => {
  if (!repoSlug) return [];

  const perPage = 100;
  const releases = [];

  for (let page = 1; page <= 10; page += 1) {
    try {
      const response = await fetch(
        `https://api.github.com/repos/${repoSlug}/releases?per_page=${perPage}&page=${page}`,
        {
          headers: {
            Accept: 'application/vnd.github+json'
          }
        }
      );

      if (!response.ok) break;

      const batch = await response.json();
      if (!Array.isArray(batch) || batch.length === 0) break;
      releases.push(...batch);
      if (batch.length < perPage) break;
    } catch (e) {
      // Ignore API failures and fall back to rendering without counts.
      break;
    }
  }

  return releases;
};

const aggregateDownloadCountsByName = (releases, cutoffTag) => {
  const totals = {};
  if (!Array.isArray(releases) || releases.length === 0) return totals;

  // Releases endpoint is newest -> oldest. Keep cutoff tag and everything older.
  let selected = releases.filter((release) => Array.isArray(release?.assets));
  if (cutoffTag) {
    const cutoffIndex = selected.findIndex((release) => release?.tag_name === cutoffTag);
    if (cutoffIndex >= 0) {
      selected = selected.slice(cutoffIndex);
    }
  }

  for (const release of selected) {
    for (const asset of release.assets) {
      if (!asset?.name) continue;
      totals[asset.name] = (totals[asset.name] || 0) + (Number(asset.download_count) || 0);
    }
  }

  return totals;
};

const formatDownloadCount = (count) => {
  if (!Number.isFinite(count)) return '';
  return `${new Intl.NumberFormat('en-US').format(count)} downloads`;
};

const formatCompactDownloadCount = (count) => {
  if (!Number.isFinite(count)) return '';
  return new Intl.NumberFormat('en-US', {
    notation: 'compact',
    maximumFractionDigits: 1
  }).format(count);
};

const repoSlug = parseGitHubRepo(repoBase);
const releases = hasRelease ? await fetchReleases(repoSlug) : [];
const downloadCountsByName = aggregateDownloadCountsByName(releases, tag);

const winDownloadCount = Number(winFile?.name ? downloadCountsByName[winFile.name] : NaN);
const linuxDownloadCount = Number(linuxFile?.name ? downloadCountsByName[linuxFile.name] : NaN);
const winDownloadText = formatDownloadCount(winDownloadCount);
const linuxDownloadText = formatDownloadCount(linuxDownloadCount);
const winDownloadBadgeValue = formatCompactDownloadCount(winDownloadCount);
const linuxDownloadBadgeValue = formatCompactDownloadCount(linuxDownloadCount);
---

<BaseLayout title={title} description={description} version={version}>
  <section class="section" id="download">
    <div class="container">
      <h2 class="section-title">Download EasyBackupManager</h2>

      {hasRelease ? (
        <Fragment>
          <p class="section-subtitle">Latest version: <strong>v{version}</strong> &mdash; released {latestRelease.released_at}</p>

          <div class="download-assets">
            {winFile && (
              <div class="download-asset">
                <div class="os-label">Windows</div>
                <div class="filename">{winFile.name}</div>
                <div class="download-actions">
                  <div class="download-primary-action">
                    <a href={winUrl} class="btn btn-primary">Download for Windows</a>
                    {winDownloadBadgeValue && (
                      <a
                        href={releaseUrl || winUrl}
                        class="github-download-badge"
                        aria-label={`GitHub ${winDownloadText}`}
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <span class="github-download-badge-label">
                          <svg viewBox="0 0 16 16" aria-hidden="true" class="github-download-badge-icon">
                            <path
                              fill="currentColor"
                              d="M8 0C3.58 0 0 3.58 0 8a8.01 8.01 0 0 0 5.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52 0-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.5-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.5 7.5 0 0 1 4 0c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z"
                            />
                          </svg>
                          github downloads
                        </span>
                        <span class="github-download-badge-value">{winDownloadBadgeValue}</span>
                      </a>
                    )}
                  </div>
                  <button class="btn btn-secondary" type="button" data-platform="windows" data-name={winFile.name} data-sha={winFile.sha256}>Download checksum file</button>
                </div>
                {winFile.sha256 && (
                  <Fragment>
                    <div class="checksum-label">SHA256</div>
                    <div class="checksum-value">{winFile.sha256}</div>
                    <a href="/verify/windows/">Full verification instructions (Windows)</a>
                  </Fragment>
                )}
              </div>
            )}
            {linuxFile && (
              <div class="download-asset">
                <div class="os-label">Linux</div>
                <div class="filename">{linuxFile.name}</div>
                <div class="download-actions">
                  <div class="download-primary-action">
                    <a href={linuxUrl} class="btn btn-primary">Download for Linux</a>
                    {linuxDownloadBadgeValue && (
                      <a
                        href={releaseUrl || linuxUrl}
                        class="github-download-badge"
                        aria-label={`GitHub ${linuxDownloadText}`}
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <span class="github-download-badge-label">
                          <svg viewBox="0 0 16 16" aria-hidden="true" class="github-download-badge-icon">
                            <path
                              fill="currentColor"
                              d="M8 0C3.58 0 0 3.58 0 8a8.01 8.01 0 0 0 5.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52 0-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.5-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82a7.5 7.5 0 0 1 4 0c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z"
                            />
                          </svg>
                          github downloads
                        </span>
                        <span class="github-download-badge-value">{linuxDownloadBadgeValue}</span>
                      </a>
                    )}
                  </div>
                  <button class="btn btn-secondary" type="button" data-platform="linux" data-name={linuxFile.name} data-sha={linuxFile.sha256}>Download checksum file</button>
                </div>
                {linuxFile.sha256 && (
                  <Fragment>
                    <div class="checksum-label">SHA256</div>
                    <div class="checksum-value">{linuxFile.sha256}</div>
                    <a href="/verify/linux/">Full verification instructions (Linux)</a>
                  </Fragment>
                )}
              </div>
            )}
          </div>

        </Fragment>
      ) : (
        <p class="section-subtitle">Release information is currently unavailable.</p>
      )}
  
    </div>
  </section>
</BaseLayout>

<script>
function normalizeSha(s) {
  if (!s) return '';
  return String(s).replace(/^sha256:/i, '');
}

function generateSumsFromElement(el) {
  try {
    if(!el) return;
    var name = el.getAttribute('data-name');
    var sha = normalizeSha(el.getAttribute('data-sha') || '');
    if(!name) return alert('File name missing');
    var content = sha + '  ' + name + '\n';
    var blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'SHA256SUMS.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 1500);
  } catch(e) {
    console.error(e);
    alert('Failed to generate checksum file');
  }
}

document.addEventListener('DOMContentLoaded', function () {
  try {
    document.querySelectorAll('button[data-sha], button[data-name]').forEach(function (btn) {
      if (btn._ebmAttached) return;
      btn.addEventListener('click', function () { generateSumsFromElement(btn); });
      btn._ebmAttached = true;
    });
  } catch (e) {
    console.error('EBM checksum attach failed', e);
  }
});
</script>
